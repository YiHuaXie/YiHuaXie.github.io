<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Objective-C,">










<meta name="description" content="KVO底层实现以及实现一个以Block形式调用的KVO">
<meta name="keywords" content="Objective-C">
<meta property="og:type" content="article">
<meta property="og:title" content="KVO实现原理">
<meta property="og:url" content="http://www.neroxie.com/2019/07/12/KVO实现原理/index.html">
<meta property="og:site_name" content="NeroXie的个人博客">
<meta property="og:description" content="KVO底层实现以及实现一个以Block形式调用的KVO">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://neroblog.oss-cn-hangzhou.aliyuncs.com/kvo_isa_swizzling.jpg">
<meta property="og:image" content="https://neroblog.oss-cn-hangzhou.aliyuncs.com/kvo%E6%B4%BE%E7%94%9F%E7%B1%BB.jpg">
<meta property="og:image" content="https://neroblog.oss-cn-hangzhou.aliyuncs.com/kvo_setter.jpg">
<meta property="og:updated_time" content="2022-11-23T20:14:09.305Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="KVO实现原理">
<meta name="twitter:description" content="KVO底层实现以及实现一个以Block形式调用的KVO">
<meta name="twitter:image" content="https://neroblog.oss-cn-hangzhou.aliyuncs.com/kvo_isa_swizzling.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.neroxie.com/2019/07/12/KVO实现原理/">





  <title>KVO实现原理 | NeroXie的个人博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/YiHuaXie" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">NeroXie的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.neroxie.com/2019/07/12/KVO实现原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="NeroXie">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/17306472?s=460&v=4F">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="NeroXie的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">KVO实现原理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-12T22:43:50+00:00">
                2019-07-12
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2022-11-23T20:14:09+00:00">
                2022-11-23
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/KVO-KVC/" itemprop="url" rel="index">
                    <span itemprop="name">KVO&KVC</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.7k
                </span>
              

              

              
            </div>
          

          
              <div class="post-description">
                  KVO底层实现以及实现一个以Block形式调用的KVO
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在iOS开发中，我们可以通过KVO机制来监听某个对象的某个属性的变化。</p>
<h2 id="KVO实现步骤"><a href="#KVO实现步骤" class="headerlink" title="KVO实现步骤"></a>KVO实现步骤</h2><p>KVO的实现分为三步：</p>
<ol>
<li><p><code>- (void)addObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath options:(NSKeyValueObservingOptions)options context:(nullable void *)context;</code></p>
</li>
<li><p><code>- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context;</code></p>
</li>
<li><p><code>- (void)removeObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath;</code></p>
</li>
</ol>
<h2 id="KVO实现机制"><a href="#KVO实现机制" class="headerlink" title="KVO实现机制"></a>KVO实现机制</h2><p>KVO的实现依赖于RunTime，在Apple的文档中有提到过KVO的实现：</p>
<blockquote>
<p>Automatic key-value observing is implemented using a technique called isa-swizzling.</p>
</blockquote>
<blockquote>
<p>The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.</p>
</blockquote>
<blockquote>
<p>When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.</p>
</blockquote>
<blockquote>
<p>You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.</p>
</blockquote>
<p>Apple的文档提到KVO是使用了<code>isa-swizzling</code>的技术。当观察者注册对象的属性时，观察对象的<code>isa</code>指针被修改，指向中间类而不是真正的类。因此，<code>isa</code>指针的值不一定反映实例的实际类。另外还提到我们不应该依赖<code>isa</code>指针来确定类成员资格，而是使用类方法来确定对象实例的类。</p>
<h3 id="isa-swizzling"><a href="#isa-swizzling" class="headerlink" title="isa-swizzling"></a>isa-swizzling</h3><p>先用一段代码验证一下KVO的实现是不是进行了<code>isa-swizzling</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@interface KVOTestModel : NSObject</span><br><span class="line">    </span><br><span class="line">@property (nonatomic, copy) NSString *name;</span><br><span class="line"></span><br><span class="line">- (void)printInfo;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation KVOTestModel</span><br><span class="line"></span><br><span class="line">- (void)printInfo &#123;</span><br><span class="line">    NSLog(@&quot;isa:%@, supper class:%@&quot;, NSStringFromClass(object_getClass(self)), class_getSuperclass(object_getClass(self)));</span><br><span class="line">    NSLog(@&quot;self:%@, [self superclass]:%@&quot;, self, [self superclass]);</span><br><span class="line">    NSLog(@&quot;name setter function pointer:%p&quot;, class_getMethodImplementation(object_getClass(self), @selector(setName:)));</span><br><span class="line">    NSLog(@&quot;printInfo function pointer:%p&quot;, class_getMethodImplementation(object_getClass(self), @selector(printInfo)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>在<code>ViewController</code>中使用KVO监听<code>KVOTestMod</code>对象的相关属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - Lifceycle</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    self.kvoTestModel = [[KVOTestModel alloc] init];</span><br><span class="line">    NSLog(@&quot;Before KVO ---------------------------------------&quot;);</span><br><span class="line">    [self.kvoTestModel printInfo];</span><br><span class="line">    [self.kvoTestModel addObserver:self</span><br><span class="line">                        forKeyPath:@&quot;name&quot;</span><br><span class="line">                           options:NSKeyValueObservingOptionNew</span><br><span class="line">                           context:nil];</span><br><span class="line">    NSLog(@&quot;After KVO ---------------------------------------&quot;);</span><br><span class="line">    [self.kvoTestModel printInfo];</span><br><span class="line">    [self.kvoTestModel removeObserver:self forKeyPath:@&quot;name&quot;];</span><br><span class="line">    NSLog(@&quot;Remove KVO ---------------------------------------&quot;);</span><br><span class="line">    [self.kvoTestModel printInfo];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - KVO</span><br><span class="line"></span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath</span><br><span class="line">                      ofObject:(id)object</span><br><span class="line">                        change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change</span><br><span class="line">                       context:(void *)context &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印一下结果：<img src="https://neroblog.oss-cn-hangzhou.aliyuncs.com/kvo_isa_swizzling.jpg" alt="isa-swizzling"></p>
<p>添加KVO之后，<code>isa</code>已经替换成了<code>NSKVONotifying_Person</code>,而根据<code>class_getSuperclass</code>得到的结果竟然是<code>Person</code>, 然后<code>name</code>是使我们KVO需要观察的属性，它的<code>setter</code>函数指针变了。</p>
<p>这里先直接总结KVO的实现原理：</p>
<ul>
<li><p>add observer</p>
<ol>
<li>通过runtime生成一个以<code>NSKVONotifying_</code>+<code>类名</code>的形式来命名的派生类；</li>
<li>将被观察的对象的<code>isa</code>指针指向这个派生类；</li>
<li>重写派生类的<code>setter</code>方法，重写<code>setter</code>方法的本质是在赋值语句之前调用<code>willChangeValueForKey</code>，赋值之后调用<code>didChangeValueForKey</code>，在<code>didChangeValueForKey</code>中调用<code>observeValueForKeyPath:ofObject:change:context:</code>方法。</li>
</ol>
</li>
<li><p>remove observer</p>
<p>  将其的<code>isa</code>指针指向原来的类对象中</p>
</li>
</ul>
<h3 id="KVO派生类"><a href="#KVO派生类" class="headerlink" title="KVO派生类"></a>KVO派生类</h3><p>在使用了KVO添加了观察者以后，runtime会生成一个<code>NSKVONotifying_</code>开头的派生类，那这个类做了些什么呢？验证代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">// KVOTestModel类</span><br><span class="line"></span><br><span class="line">@interface KVOTestModel : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, copy) NSString *name;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation KVOTestModel</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// 打印类的方法列表</span><br><span class="line">void printClassMethod(Class aClass) &#123;</span><br><span class="line">    unsigned int count;</span><br><span class="line">    Method *methodList = class_copyMethodList(aClass, &amp;count);</span><br><span class="line">    NSMutableString *methodNames = [NSMutableString string];</span><br><span class="line">    </span><br><span class="line">    for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        Method aMethod =methodList[i];</span><br><span class="line">        NSString *aMethodString = NSStringFromSelector(method_getName(aMethod));</span><br><span class="line">        [methodNames appendString:[NSString stringWithFormat:@&quot;%@, &quot;, aMethodString]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(methodList);</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;%@&quot;, methodNames);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//调用代码</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    self.kvoTestModel = [[KVOTestModel alloc] init];</span><br><span class="line">    self.kvoTestModel2 = [[KVOTestModel alloc] init];</span><br><span class="line">    </span><br><span class="line">    [self.kvoTestModel addObserver:self</span><br><span class="line">                        forKeyPath:@&quot;name&quot;</span><br><span class="line">                           options:NSKeyValueObservingOptionNew</span><br><span class="line">                           context:nil];</span><br><span class="line">    </span><br><span class="line">    printClassMethod(object_getClass(self.kvoTestModel));</span><br><span class="line">    printClassMethod(object_getClass(self.kvoTestModel2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：<img src="https://neroblog.oss-cn-hangzhou.aliyuncs.com/kvo%E6%B4%BE%E7%94%9F%E7%B1%BB.jpg" alt="kvo派生类"></p>
<p>从上面的结果可以得出，派生类重写了四个方法分别是：</p>
<ol>
<li>重写Setter方法；</li>
<li>重写Class方法，苹果官方并不想让我们知道KVO的具体实现，所以重写了Class方法以返回其原来的类，这也证实了使用了KVO的实例对象为什么调用<code>class</code>方法和<code>object_getClass</code>方法但是结果不一样；</li>
<li>实现了dealloc方法，用来实现KVO的一些收尾工作；</li>
<li>实现了_isKVOA方法，应该是KVO内部的一个私有方法；</li>
</ol>
<h3 id="重写Setter方法"><a href="#重写Setter方法" class="headerlink" title="重写Setter方法"></a>重写Setter方法</h3><p>上面提到必须是派生类重写<code>setter</code>方法，如果是直接对属性进行赋值的话，是不会触发KVO的。虽然Apple并没有开源KVO的代码，但是我们可以通过验证的方式进行推导。</p>
<p>在<code>KVOTestModel</code>文件中添加以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - Override</span><br><span class="line"></span><br><span class="line">- (void)willChangeValueForKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@&quot;willChangeValueForKey beigin&quot;);</span><br><span class="line">    </span><br><span class="line">    [super willChangeValueForKey:key];</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;willChangeValueForKey end&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)didChangeValueForKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@&quot;didChangeValueForKey beigin&quot;);</span><br><span class="line">    </span><br><span class="line">    [super didChangeValueForKey:key];</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;didChangeValueForKey end&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - Setter</span><br><span class="line"></span><br><span class="line">- (void)setName:(NSString *)name &#123;</span><br><span class="line">    _name = name;</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印结果：<img src="https://neroblog.oss-cn-hangzhou.aliyuncs.com/kvo_setter.jpg" alt="setter"></p>
<p>从上面的结果我们可以知道KVO在重写<code>setter</code>方法后大概分成三个步骤：</p>
<ol>
<li>先调用<code>willChangeValueForKey</code>；</li>
<li>调用父类的<code>setter</code>方法；</li>
<li>调用<code>didChangeValueForKey</code>，<code>didChangeValueForKey</code>中会调用KVO的相关代理方法来通知观察者。</li>
</ol>
<h3 id="keyPath"><a href="#keyPath" class="headerlink" title="keyPath"></a>keyPath</h3><p>keyPath使用我们用来监听的属性，它的实质是什么？先看一段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//Person.h</span><br><span class="line">@interface Person : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, copy) NSString *nick;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//Person.m</span><br><span class="line">@synthesize nick = realNick;</span><br><span class="line"></span><br><span class="line">- (void)setNick:(NSString *)nick &#123;</span><br><span class="line">    realNick = nick;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSString *)nick &#123;</span><br><span class="line">    return realNick;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ViewController</span><br><span class="line">- (void)_testKeyPath &#123;</span><br><span class="line">    self.person = [[Person alloc] init];</span><br><span class="line">    [self.person addObserver:self</span><br><span class="line">                  forKeyPath:@&quot;nick&quot;//&quot;realNick&quot;</span><br><span class="line">                     options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld</span><br><span class="line">                     context:nil];</span><br><span class="line">    self.person.nick = @&quot;Nero&quot;;</span><br><span class="line">    [self.person removeObserver:self forKeyPath:@&quot;nick&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际结果是，使用<code>nick</code>能够监听到对应变化，而使用真正的实例变量<code>realNick</code>时，无法监听到值。<code>keyPath</code>指向的并不是真正的实例变量，而是对于<code>setter</code>方法的关联，KVO会使用<code>keypath</code>作为后缀去寻找原类的<code>setter</code>方法的方法签名，和实际存取对象和属性名称没有关系。所以这也是为什么我们重命名了<code>setter</code>方法之后，没有办法再去使用KVO或KVC了，需要手动调用一次<code>willChangeValue</code>方法。</p>
<h2 id="手动触发一个KVO"><a href="#手动触发一个KVO" class="headerlink" title="手动触发一个KVO"></a>手动触发一个KVO</h2><p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//Person</span><br><span class="line">@interface Person : NSObject &#123;</span><br><span class="line">@public NSInteger age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//ViewController</span><br><span class="line">- (void)_testImplementKVOManually &#123;</span><br><span class="line">    self.person = [[Person alloc] init];</span><br><span class="line">    [self.person addObserver:self</span><br><span class="line">                  forKeyPath:@&quot;age&quot;</span><br><span class="line">                     options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld</span><br><span class="line">                     context:nil];</span><br><span class="line">    [self.person willChangeValueForKey:@&quot;age&quot;];//获取旧值</span><br><span class="line">    self.person-&gt;age = 26;</span><br><span class="line">    [self.person didChangeValueForKey:@&quot;age&quot;];//获取新值</span><br><span class="line">    [self.person removeObserver:self forKeyPath:@&quot;age&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="KVO的跨线程监听"><a href="#KVO的跨线程监听" class="headerlink" title="KVO的跨线程监听"></a>KVO的跨线程监听</h2><p>我们知道使用Notification时，跨线程发送通知是无法被接受到的，但是KVO是可以跨线程监听的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (void)_testKVOinGCD &#123;</span><br><span class="line">    dispatch_queue_t queue = dispatch_queue_create(&quot;test.concurrent.queue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    self.person = [Person new];</span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [NSDate date]);</span><br><span class="line">        self.person.name = @&quot;Nero&quot;;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [NSDate date]);</span><br><span class="line">        sleep(1);</span><br><span class="line">        [self.person addObserver:self</span><br><span class="line">                      forKeyPath:@&quot;name&quot;</span><br><span class="line">                         options:NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld</span><br><span class="line">                         context:nil];</span><br><span class="line">        NSLog(@&quot;%@&quot;, [NSDate date]);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">        NSLog(@&quot;%@&quot;, [NSDate date]);</span><br><span class="line">        self.person.name = @&quot;NeroXie&quot;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在两个不同的线程里创建的Observer和Target，观察变化也是能够生效的。<br>这里使用了<code>dispatch_barrier_async</code>是确保第三个task在前两个task运行后再执行，而且使用的队列必须是自定义的并发队列，如果使用全局队列，栅栏就不想起作用了，因为<code>dispatch_barrier_async</code>相当于<code>dispatch_asysc</code></p>
<h2 id="KVO拾遗"><a href="#KVO拾遗" class="headerlink" title="KVO拾遗"></a>KVO拾遗</h2><ul>
<li>子类继承父类的一个属性(无论是否被暴露)，当这个属性被改变时，KVO都能观察到。</li>
</ul>
<p>因为继承的关系Father &lt;- Son &lt;- KVOSon，当我监听一个父类属性的keyPath的时候，Son实例同样可以通过消息查找找到父类的setter方法，再将该方法加入到KVOSon类当中去。</p>
<ul>
<li>子类继承父类属性并重写了它的setter方法，当这个属性被改变时，KVO能观察到。</li>
</ul>
<p>在上一条中知道，其实子类监听父类属性，并不依赖继承，而是通过ISA指针在消息转发的时候能够获取到父类方法就足够。所以当我们重写父类setter方法，相当于在子类定义了该setter函数，在我们去用sel找方法签名时，直接在子类中就拿到了，甚至都不需要去到父类里。所以理解了KVO监听父类属性和继承没有直接联系这一点，就不再纠结set方法是否重写这个问题了。</p>
<h2 id="补充：以Block的形式实现KVO"><a href="#补充：以Block的形式实现KVO" class="headerlink" title="补充：以Block的形式实现KVO"></a>补充：以Block的形式实现KVO</h2><p>通过上面的API我们知道KVO的调用相对来说是有点繁琐的，所以我用Category实现了KVO的Block形式的调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line">// 声明</span><br><span class="line">@interface NSObject(KVOBlock)</span><br><span class="line"></span><br><span class="line">- (NSString *)nn_addObserverForKeyPath:(NSString *)keyPath</span><br><span class="line">                               options:(NSKeyValueObservingOptions)options</span><br><span class="line">                            usingBlock:(void (^)(id obj, NSString *keyPath, NSDictionary *change))block;</span><br><span class="line"></span><br><span class="line">- (void)nn_removeBlockObserverWithIdentifier:(NSString *)identifier;</span><br><span class="line">- (void)nn_removeAllBlockObservers;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// 实现</span><br><span class="line">#pragma mark - NSObject+KVOBlock</span><br><span class="line"></span><br><span class="line">static void *NNObserverBlockContext = &amp;NNObserverBlockContext;</span><br><span class="line"></span><br><span class="line">typedef void (^NNObserverBlock) (id obj, NSString *keyPath, NSDictionary&lt;NSKeyValueChangeKey,id&gt; *change);</span><br><span class="line"></span><br><span class="line">#pragma mark - Private Class</span><br><span class="line"></span><br><span class="line">@interface _NNInternalObserver : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign) BOOL isObserving;</span><br><span class="line">@property (nonatomic, weak) id observed;</span><br><span class="line">@property (nonatomic, copy) NSString *keyPath;</span><br><span class="line">@property (nonatomic, copy) NNObserverBlock observerBlock;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation _NNInternalObserver</span><br><span class="line"></span><br><span class="line">#pragma mark - Init</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithObserved:(id)observed</span><br><span class="line">                         keyPath:(NSString *)keyPath</span><br><span class="line">                   observerBlock:(NNObserverBlock)observerBlock &#123;</span><br><span class="line">    if ((self = [super init])) &#123;</span><br><span class="line">        self.isObserving = NO;</span><br><span class="line">        self.observed = observed;</span><br><span class="line">        self.keyPath = keyPath;</span><br><span class="line">        self.observerBlock = [observerBlock copy];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    if (self.keyPath) [self stopObserving];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - Helper</span><br><span class="line"></span><br><span class="line">- (void)startObservingWithOptions:(NSKeyValueObservingOptions)options &#123;</span><br><span class="line">    @synchronized(self) &#123;</span><br><span class="line">        if (self.isObserving) return;</span><br><span class="line">        </span><br><span class="line">        [self.observed addObserver:self forKeyPath:self.keyPath options:options context:NNObserverBlockContext];</span><br><span class="line">        </span><br><span class="line">        self.isObserving = YES;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)stopObserving &#123;</span><br><span class="line">    NSParameterAssert(self.keyPath);</span><br><span class="line">    </span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        if (!self.isObserving) return;</span><br><span class="line">        if (!self.observed) return;</span><br><span class="line">        </span><br><span class="line">        [self.observed removeObserver:self forKeyPath:self.keyPath context:NNObserverBlockContext];</span><br><span class="line">        </span><br><span class="line">        self.observed = nil;</span><br><span class="line">        self.keyPath = nil;</span><br><span class="line">        self.observerBlock = nil;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - KVO</span><br><span class="line"></span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context &#123;</span><br><span class="line">    if (context != NNObserverBlockContext) return;</span><br><span class="line">    </span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        self.observerBlock(object, keyPath, change);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface NSObject()</span><br><span class="line"></span><br><span class="line">/** 保存所有的block */</span><br><span class="line">@property (nonatomic, strong, setter=nn_setObserverBlockMap:) NSMutableDictionary *nn_observerBlockMap;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation NSObject(KVOBlock)</span><br><span class="line"></span><br><span class="line">/** 所有修改过dealloc方法的类 */</span><br><span class="line">+ (NSMutableSet *)nn_observedClasses &#123;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    static NSMutableSet *classes = nil;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        classes = [[NSMutableSet alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    return classes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - Public</span><br><span class="line"></span><br><span class="line">- (NSString *)nn_addObserverForKeyPath:(NSString *)keyPath</span><br><span class="line">                               options:(NSKeyValueObservingOptions)options</span><br><span class="line">                                  usingBlock:(void (^)(id obj, NSString *keyPath, NSDictionary *change))block &#123;</span><br><span class="line">    NSString *identifier = [NSProcessInfo processInfo].globallyUniqueString;</span><br><span class="line">    [self nn_addObserverForKeyPath:keyPath identifier:identifier options:options block:block];</span><br><span class="line">    </span><br><span class="line">    return identifier;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)nn_removeBlockObserverWithIdentifier:(NSString *)identifier &#123;</span><br><span class="line">    NSParameterAssert(identifier.length);</span><br><span class="line">    </span><br><span class="line">    NSMutableDictionary *dict;</span><br><span class="line">    </span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        dict = self.nn_observerBlockMap;</span><br><span class="line">        if (!dict) return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _NNInternalObserver *observer = dict[identifier];</span><br><span class="line">    [observer stopObserving];</span><br><span class="line">    [dict removeObjectForKey:identifier];</span><br><span class="line">    if (dict.count == 0) self.nn_observerBlockMap = nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)nn_removeAllBlockObservers &#123;</span><br><span class="line">    NSDictionary *dict;</span><br><span class="line">    </span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        dict = [self.nn_observerBlockMap copy];</span><br><span class="line">        self.nn_observerBlockMap = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [dict.allValues enumerateObjectsUsingBlock:^(_NNInternalObserver *obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">        [obj stopObserving];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - Core Method</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> KVO Block 实现</span><br><span class="line"> </span><br><span class="line"> @param keyPath     被观察的属性</span><br><span class="line"> @param identifier  唯一标识符 用来标记内部观察者</span><br><span class="line"> @param options     观察选项</span><br><span class="line"> @param block       KVO Block</span><br><span class="line"> */</span><br><span class="line">- (void)nn_addObserverForKeyPath:(NSString *)keyPath</span><br><span class="line">                      identifier:(NSString *)identifier</span><br><span class="line">                         options:(NSKeyValueObservingOptions)options</span><br><span class="line">                            block:(NNObserverBlock)block &#123;</span><br><span class="line">    NSParameterAssert(keyPath.length);</span><br><span class="line">    NSParameterAssert(identifier.length);</span><br><span class="line">    NSParameterAssert(block);</span><br><span class="line">    </span><br><span class="line">    Class classToSwizzle = self.class;</span><br><span class="line">    NSMutableSet *classes = self.class.nn_observedClasses;</span><br><span class="line">    @synchronized (classes) &#123;</span><br><span class="line">        NSString *className = NSStringFromClass(classToSwizzle);</span><br><span class="line">        if (![classes containsObject:className]) &#123;</span><br><span class="line">            SEL deallocSelector = sel_registerName(&quot;dealloc&quot;);</span><br><span class="line">            </span><br><span class="line">            __block void (*originalDealloc)(__unsafe_unretained id, SEL) = NULL;</span><br><span class="line">            </span><br><span class="line">            id newDealloc = ^(__unsafe_unretained id objSelf) &#123;</span><br><span class="line">                [objSelf nn_removeAllBlockObservers];</span><br><span class="line">                </span><br><span class="line">                if (originalDealloc == NULL) &#123;</span><br><span class="line">                    struct objc_super superInfo = &#123;</span><br><span class="line">                        .receiver = objSelf,</span><br><span class="line">                        .super_class = class_getSuperclass(classToSwizzle)</span><br><span class="line">                    &#125;;</span><br><span class="line">                    </span><br><span class="line">                    void (*msgSend)(struct objc_super *, SEL) = (__typeof__(msgSend))objc_msgSendSuper;</span><br><span class="line">                    msgSend(&amp;superInfo, deallocSelector);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    originalDealloc(objSelf, deallocSelector);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            IMP newDeallocIMP = imp_implementationWithBlock(newDealloc);</span><br><span class="line">            </span><br><span class="line">            if (!class_addMethod(classToSwizzle, deallocSelector, newDeallocIMP, &quot;v@:&quot;)) &#123;</span><br><span class="line">                Method deallocMethod = class_getInstanceMethod(classToSwizzle, deallocSelector);</span><br><span class="line">                originalDealloc = (void(*)(__unsafe_unretained id, SEL))method_getImplementation(deallocMethod);</span><br><span class="line">                originalDealloc = (void(*)(__unsafe_unretained id, SEL))method_setImplementation(deallocMethod, newDeallocIMP);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            [classes addObject:className];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _NNInternalObserver *observer = [[_NNInternalObserver alloc] initWithObserved:self</span><br><span class="line">                                                                          keyPath:keyPath</span><br><span class="line">                                                                    observerBlock:block];</span><br><span class="line">    [observer startObservingWithOptions:options];</span><br><span class="line">    </span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        if (!self.nn_observerBlockMap) self.nn_observerBlockMap = [NSMutableDictionary dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    self.nn_observerBlockMap[identifier] = observer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - Setter &amp; Getter</span><br><span class="line"></span><br><span class="line">- (void)nn_setObserverBlockMap:(NSMutableDictionary *)nn_observerBlockMap &#123;</span><br><span class="line">    objc_setAssociatedObject(self, @selector(nn_observerBlockMap), nn_observerBlockMap, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSMutableDictionary *)nn_observerBlockMap &#123;</span><br><span class="line">    return objc_getAssociatedObject(self, @selector(nn_observerBlockMap));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// 调用</span><br><span class="line">self.kvoTestModel = [[KVOTestModel alloc] init];</span><br><span class="line"></span><br><span class="line">NSString *identifier =</span><br><span class="line">[self.kvoTestModel nn_addObserverForKeyPath:@&quot;name&quot;</span><br><span class="line">                                    options:NSKeyValueObservingOptionNew</span><br><span class="line">                                 usingBlock:^(id obj, NSString *keyPath, NSDictionary *change) &#123;</span><br><span class="line">                                     NSLog(@&quot;%@&quot;, change);</span><br><span class="line">                                 &#125;];</span><br><span class="line"></span><br><span class="line">self.kvoTestModel.name = @&quot;Nero&quot;;</span><br><span class="line"></span><br><span class="line">// 手动结束KVO监听</span><br><span class="line">[self.kvoTestModel nn_removeBlockObserverWithIdentifier:identifier];</span><br><span class="line">    </span><br><span class="line">// 自动结束KVO监听</span><br><span class="line">self.kvoTestModel = nil;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    NeroXie
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://www.neroxie.com/2019/07/12/KVO实现原理/" title="KVO实现原理">http://www.neroxie.com/2019/07/12/KVO实现原理/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Objective-C/" rel="tag"># Objective-C</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/06/React-Native实现一个带筛选功能的搜房列表（3）/" rel="next" title="React Native实现一个带筛选功能的搜房列表（3）">
                <i class="fa fa-chevron-left"></i> React Native实现一个带筛选功能的搜房列表（3）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/12/KVC实现原理/" rel="prev" title="KVC实现原理">
                KVC实现原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="gitalk-container"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://avatars1.githubusercontent.com/u/17306472?s=460&v=4F" alt="NeroXie">
            
              <p class="site-author-name" itemprop="name">NeroXie</p>
              <p class="site-description motion-element" itemprop="description">May the Force be with you</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/YiHuaXie" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:xyh30902@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/595c8f866fb9a06bbf6fecba" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-globe"></i>掘金</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/17c52abac13c" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-heartbeat"></i>简书</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO实现步骤"><span class="nav-number">1.</span> <span class="nav-text">KVO实现步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO实现机制"><span class="nav-number">2.</span> <span class="nav-text">KVO实现机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#isa-swizzling"><span class="nav-number">2.1.</span> <span class="nav-text">isa-swizzling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KVO派生类"><span class="nav-number">2.2.</span> <span class="nav-text">KVO派生类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重写Setter方法"><span class="nav-number">2.3.</span> <span class="nav-text">重写Setter方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keyPath"><span class="nav-number">2.4.</span> <span class="nav-text">keyPath</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#手动触发一个KVO"><span class="nav-number">3.</span> <span class="nav-text">手动触发一个KVO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO的跨线程监听"><span class="nav-number">4.</span> <span class="nav-text">KVO的跨线程监听</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO拾遗"><span class="nav-number">5.</span> <span class="nav-text">KVO拾遗</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补充：以Block的形式实现KVO"><span class="nav-number">6.</span> <span class="nav-text">补充：以Block的形式实现KVO</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NeroXie</span>

  
</div>


  <div class="powered-by">NeroXie的个人博客</div>




<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共70.1k字</span>
</div>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '5e5c6074ea6483a9380d',
          clientSecret: 'd16d85928f70d31702f591a6ba8c47b3b8fe432c',
          repo: 'YiHuaXie.github.io',
          owner: 'YiHuaXie',
          admin: ['YiHuaXie'],
          id: md5(location.pathname),
         labels: 'gitalk'.split(',').filter(l => l),
          perPage: 15,
          pagerDirection: 'last',
          createIssueManually: false,
          distractionFreeMode: true
        })
        gitalk.render('gitalk-container')           
       </script>




  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
